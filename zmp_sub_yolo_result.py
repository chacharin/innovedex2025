# ЁЯФМ р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╣Др╕ер╕Ър╕гр╕▓р╕гр╕╡ zmq (ZeroMQ) р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕кр╕╖р╣Ир╕нр╕кр╕▓р╕гр╣Бр╕Ър╕Ъ socket-based р╣Бр╕ер╕░ json р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕бр╕╣р╕е
import zmq
import json

# тЬЕ р╕кр╕гр╣Йр╕▓р╕З context р╕Лр╕╢р╣Ир╕Зр╣Ар╕Ыр╣Зр╕Щ environment р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕г socket р╕лр╕ер╕▓р╕вр╕Хр╕▒р╕зр╣Гр╕Щ ZeroMQ
context = zmq.Context()

# тЬЕ р╕кр╕гр╣Йр╕▓р╕З socket р╣Бр╕Ър╕Ъ SUB (Subscriber) тЖТ р╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ъ "р╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е" р╕Ир╕▓р╕Б Publisher
socket = context.socket(zmq.SUB)

# ЁЯУб р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ Publisher р╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Ър╕Щ address р╕Чр╕╡р╣Ир╕Бр╕│р╕лр╕Щр╕Ф
# р╕лр╕▓р╕Б Publisher р╣Бр╕ер╕░ Subscriber р╕нр╕вр╕╣р╣Ир╕Ър╕Щр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ р╣Гр╕лр╣Йр╣Гр╕Кр╣Й "localhost"
# р╕лр╕▓р╕Бр╕Хр╣Ир╕▓р╕Зр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╣Гр╕лр╣Йр╣Гр╕Кр╣Й "tcp://<IP>:5555" р╣Ар╕Кр╣Ир╕Щ "tcp://192.168.1.100:5555"
socket.connect("tcp://localhost:5555")

# тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕лр╣Й Subscriber р╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Ир╕▓р╕Б Publisher
# р╕Цр╣Йр╕▓р╕нр╕вр╕▓р╕Бр╕Бр╕гр╕нр╕Зр╣Ар╕Йр╕Юр╕▓р╕░р╕лр╕▒р╕зр╕Вр╣Йр╕н (topic) р╕Хр╣Йр╕нр╕Зр╕гр╕░р╕Ър╕╕ prefix р╣Ар╕Кр╣Ир╕Щ b"person" тЖТ р╣Бр╕Хр╣И "" р╕лр╕бр╕▓р╕вр╕Цр╕╢р╕Зр╕гр╕▒р╕Ър╕Чр╕╕р╕Бр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б
socket.setsockopt_string(zmq.SUBSCRIBE, "")

# ЁЯФБ р╕зр╕Щр╕ер╕╣р╕Ыр╕гр╕нр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ир╕▓р╕Б Publisher р╕нр╕вр╣Ир╕▓р╕Зр╕Хр╣Ир╕нр╣Ар╕Щр╕╖р╣Ир╕нр╕З
while True:
    # ЁЯУй р╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ир╕▓р╕Б Publisher (р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╕кр╣Ир╕Зр╕бр╕▓р╕Ир╕░р╣Ар╕Ыр╣Зр╕Щ JSON string)
    message = socket.recv_string()

    # ЁЯФД р╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б JSON (string) р╕Чр╕╡р╣Ир╕гр╕▒р╕Ър╕бр╕▓р╣Гр╕лр╣Йр╕Бр╕ер╕▓р╕вр╣Ар╕Ыр╣Зр╕Щ Python object (list of dict)
    # р╣Ар╕Кр╣Ир╕Щ [{'label': 'person', 'x': 300, 'y': 200, 'w': 100, 'h': 150, 'conf': 0.89}]
    detections = json.loads(message)

    # ЁЯФН р╕зр╕Щр╕ер╕╣р╕Ыр╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ър╣Бр╕Хр╣Ир╕ер╕░р╕гр╕▓р╕вр╕Бр╕▓р╕г
    for det in detections:
        # р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е label, center x/y, р╕Др╕зр╕▓р╕бр╕Бр╕зр╣Йр╕▓р╕З/р╕кр╕╣р╕З, р╣Бр╕ер╕░р╕Др╕зр╕▓р╕бр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕▒р╣Ир╕Щ
        print(f"[{det['label']}] x={det['x']} y={det['y']} w={det['w']} h={det['h']} conf={det['conf']}")
